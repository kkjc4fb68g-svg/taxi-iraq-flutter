import 'package:flutter/material.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';
import 'package:location/location.dart';
import 'dart:math';

void main() {
  runApp(const TaxiIraqApp());
}

class TaxiIraqApp extends StatelessWidget {
  const TaxiIraqApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'Taxi Iraq',
      theme: ThemeData(
        primarySwatch: Colors.green,
        fontFamily: 'Arial',
      ),
      home: const HomeScreen(),
    );
  }
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  late GoogleMapController mapController;
  LatLng? currentLocation;
  LatLng? destinationLocation;
  double? fare;
  bool searching = false;
  bool confirmedDestination = false;

  final Location locationService = Location();
  final Set<Marker> markers = {};

  final TextEditingController destinationController = TextEditingController();

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…ÙˆØ³Ø¹Ø© ÙÙŠ Ø§Ù„ÙÙ„ÙˆØ¬Ø©
  final List<String> popularPlaces = [
    "Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø£Ù†ØµØ§Ø±",
    "Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ",
    "Ø¬Ø§Ù…Ø¹ Ø§Ù„ÙƒØ¨ÙŠØ±",
    "Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
    "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø±Ø´ÙŠØ¯",
    "Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ©",
    "Ø³ÙˆÙ‚ Ø§Ù„ÙÙ„ÙˆØ¬Ø©",
    "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ÙÙ„ÙˆØ¬Ø© Ø§Ù„Ø¹Ø§Ù…",
    "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø·Ø¨Ø§Ø¨Ø© Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠØ©",
    "Ù…Ø±ÙƒØ² Ø§Ù„Ø´Ø±Ø·Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ",
    "Ù…ÙŠØ¯Ø§Ù† Ø§Ù„ØªØ­Ø±ÙŠØ±",
    "Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙÙ„ÙˆØ¬Ø© Ø§Ù„Ø¹Ø§Ù…Ø©",
    "Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù†Ø¨Ø§Ø± â€“ ÙØ±Ø¹ Ø§Ù„ÙÙ„ÙˆØ¬Ø©",
    "Ù†Ù‡Ø± Ø§Ù„ÙÙ„ÙˆØ¬Ø©",
    "Ù…Ø­Ø·Ø© Ø§Ù„Ù‚Ø·Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©",
    "Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©",
    "Ø­ÙŠ Ø§Ù„ÙƒØ±Ù…Ø©",
    "Ø­ÙŠ Ø§Ù„ØµÙ†Ø§Ø¹Ø©",
    "Ù…Ø±ÙƒØ² Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„ÙƒØ¨ÙŠØ± (Ù…ÙˆÙ„ Ø§Ù„ÙÙ„ÙˆØ¬Ø©)",
    "Ù…Ø®Ø¨Ø² Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ",
    "Ù…Ø­Ø·Ø© ÙˆÙ‚ÙˆØ¯ Ø§Ù„ÙÙ„ÙˆØ¬Ø©"
  ];

  List<String> suggestions = [];

  @override
  void initState() {
    super.initState();
    _getCurrentLocation();
  }

  Future<void> _getCurrentLocation() async {
    final loc = await locationService.getLocation();
    setState(() {
      currentLocation = LatLng(loc.latitude!, loc.longitude!);
      markers.add(Marker(
        markerId: const MarkerId("current"),
        position: currentLocation!,
        infoWindow: const InfoWindow(title: "Ù…ÙƒØ§Ù†ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ"),
        icon: BitmapDescriptor.defaultMarkerWithHue(BitmapDescriptor.hueBlue),
      ));
    });
  }

  double _calculateDistance(LatLng start, LatLng end) {
    const double R = 6371;
    double dLat = _deg2rad(end.latitude - start.latitude);
    double dLon = _deg2rad(end.longitude - start.longitude);
    double a =
        sin(dLat / 2) * sin(dLat / 2) +
            cos(_deg2rad(start.latitude)) *
                cos(_deg2rad(end.latitude)) *
                sin(dLon / 2) *
                sin(dLon / 2);
    double c = 2 * atan2(sqrt(a), sqrt(1 - a));
    return R * c;
  }

  double _deg2rad(double deg) => deg * pi / 180;

  double _calculateFare(double km) {
    if (km <= 5) return 2000;
    return 2000 + ((km - 5) * 150);
  }

  void confirmDestination() {
    if (currentLocation != null && destinationLocation != null) {
      double km = _calculateDistance(currentLocation!, destinationLocation!);
      setState(() {
        fare = _calculateFare(km);
        confirmedDestination = true;
      });
    }
  }

  void searchDriver() {
    setState(() {
      searching = true;
    });

    Future.delayed(const Duration(seconds: 3), () {
      setState(() {
        searching = false;
        confirmedDestination = false;
        fare = null;
        markers.removeWhere((m) => m.markerId.value == "destination");
        destinationLocation = null;
        destinationController.clear();
      });

      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("ğŸš• ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚"),
          behavior: SnackBarBehavior.floating,
        ),
      );
    });
  }

  void updateSuggestions(String input) {
    setState(() {
      suggestions = popularPlaces
          .where((place) => place.contains(input))
          .toList();
    });
  }

  void selectSuggestion(String place) {
    setState(() {
      destinationController.text = place;
      suggestions.clear();
      // Ù†Ø¶ÙŠÙ Marker Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ù†Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªØªØ­Ø±Ùƒ Ù„Ù„ÙˆØ¬Ù‡Ø©)
      // Ù‡Ù†Ø§ Ù†ØªØ±Ùƒ Marker Ø«Ø§Ø¨ØªØŒ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ø¹ API ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ù„Ù€ LatLng
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: currentLocation == null
          ? const Center(child: CircularProgressIndicator())
          : Stack(
              children: [
                GoogleMap(
                  initialCameraPosition: CameraPosition(
                    target: currentLocation!,
                    zoom: 15,
                  ),
                  myLocationEnabled: true,
                  zoomControlsEnabled: false,
                  onMapCreated: (controller) {
                    mapController = controller;
                  },
                  markers: markers,
                  onTap: (latLng) {
                    setState(() {
                      destinationLocation = latLng;
                      confirmedDestination = false;
                      fare = null;
                      markers.removeWhere((m) => m.markerId.value == "destination");
                      markers.add(Marker(
                        markerId: const MarkerId("destination"),
                        position: latLng,
                        infoWindow: const InfoWindow(title: "Ø§Ù„ÙˆØ¬Ù‡Ø©"),
                      ));
                      suggestions.clear();
                    });
                  },
                ),
                Positioned(
                  bottom: 0,
                  left: 0,
                  right: 0,
                  child: Container(
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: const BorderRadius.vertical(
                        top: Radius.circular(24),
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black26,
                          blurRadius: 15,
                          offset: const Offset(0, -3),
                        ),
                      ],
                    ),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        const Text(
                          "Ø­Ø¯Ø¯ ÙˆØ¬Ù‡ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ù…Ø¹Ø±ÙˆÙ",
                          style: TextStyle(
                              fontSize: 18, fontWeight: FontWeight.bold),
                        ),
                        const SizedBox(height: 12),
                        TextField(
                          controller: destinationController,
                          decoration: InputDecoration(
                            hintText: "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†...",
                            prefixIcon: const Icon(Icons.place, color: Colors.green),
                            filled: true,
                            fillColor: Colors.grey[100],
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12),
                              borderSide: BorderSide.none,
                            ),
                          ),
                          onChanged: (value) {
                            updateSuggestions(value);
                          },
                        ),
                        if (suggestions.isNotEmpty)
                          Container(
                            height: 120,
                            margin: const EdgeInsets.only(top: 5),
                            child: ListView.builder(
                              itemCount: suggestions.length,
                              itemBuilder: (context, index) {
                                return ListTile(
                                  title: Text(suggestions[index]),
                                  leading: const Icon(Icons.location_on, color: Colors.green),
                                  onTap: () {
                                    selectSuggestion(suggestions[index]);
                                  },
                                );
                              },
                            ),
                          ),
                        const SizedBox(height: 12),
                        if (destinationLocation != null && !confirmedDestination)
                          SizedBox(
                            width: double.infinity,
                            child: ElevatedButton(
                              onPressed: confirmDestination,
                              style: ElevatedButton.styleFrom(
                                padding:
                                    const EdgeInsets.symmetric(vertical: 16),
                                shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12)),
                                backgroundColor: Colors.green,
                              ),
                              child: const Text(
                                "ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©",
                                style: TextStyle(fontSize: 18, color: Colors.white),
                              ),
                            ),
                          ),
                        if (confirmedDestination && fare != null) ...[
                          Card(
                            color: Colors.green[50],
                            shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12)),
                            child: ListTile(
                              leading:
                                  const Icon(Icons.attach_money, color: Colors.green),
                              title: Text(
                                "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${fare!.toInt()} Ø¯ÙŠÙ†Ø§Ø±",
                                style: const TextStyle(
                                    fontSize: 18, fontWeight: FontWeight.bold),
                              ),
                            ),
                          ),
                          const SizedBox(height: 12),
                          SizedBox(
                            width: double.infinity,
                            child: ElevatedButton(
                              onPressed: searchDriver,
                              style: ElevatedButton.styleFrom(
                                padding:
                                    const EdgeInsets.symmetric(vertical: 16),
                                shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12)),
                                backgroundColor: Colors.green,
                              ),
                              child: const Text(
                                "Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚",
                                style: TextStyle(
                                    fontSize: 18, color: Colors.white),
                              ),
                            ),
                          ),
                        ]
                      ],
                    ),
                  ),
                ),
                if (searching)
                  Container(
                    color: Colors.black45,
                    child: const Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          CircularProgressIndicator(color: Colors.white),
                          SizedBox(height: 12),
                          Text(
                            "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚...",
                            style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.bold),
                          ),
                        ],
                      ),
                    ),
                  ),
              ],
            ),
    );
  }
}
