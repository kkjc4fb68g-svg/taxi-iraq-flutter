import 'package:flutter/material.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';
import 'package:location/location.dart';
import 'dart:math';

void main() {
  runApp(const TaxiIraqApp());
}

class TaxiIraqApp extends StatelessWidget {
  const TaxiIraqApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'Taxi Iraq',
      theme: ThemeData(
        primarySwatch: Colors.green,
        fontFamily: 'Arial',
      ),
      home: const HomeScreen(),
    );
  }
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  late GoogleMapController mapController;
  final TextEditingController destinationController = TextEditingController();

  LatLng? currentLocation;
  LatLng? destinationLocation;
  double? fare;
  bool searching = false;

  final Location locationService = Location();
  final Set<Marker> markers = {};

  // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±
  final Map<String, int> carTypes = {
    "Ø§Ù‚ØªØµØ§Ø¯ÙŠ": 500,
    "ÙØ§Ø®Ø±": 750,
    "VIP": 1000,
  };
  String selectedCar = "Ø§Ù‚ØªØµØ§Ø¯ÙŠ";

  // Ù‚Ø§Ø¦Ù…Ø© Ø£Ù…Ø§ÙƒÙ† Ù…Ø´Ù‡ÙˆØ±Ø©
  final List<String> popularPlaces = [
    "Ø¬Ø§Ù…Ø¹Ø© Ø¨ØºØ¯Ø§Ø¯",
    "Ø§Ù„ÙƒØ±Ø§Ø¯Ø©",
    "Ø§Ù„Ù…Ù†ØµÙˆØ±",
    "Ø§Ù„ØªØ­Ø±ÙŠØ±",
    "Ø§Ù„Ø±ØµØ§ÙØ©",
    "Ø³Ø§Ø­Ø© Ø§Ù„ØªØ­Ø±ÙŠØ±",
    "Ø§Ù„ÙÙ„ÙˆØ¬Ø©",
    "Ø§Ù„Ù…ÙˆØµÙ„",
    "ÙƒØ±Ø¨Ù„Ø§Ø¡",
  ];

  List<String> suggestions = [];

  @override
  void initState() {
    super.initState();
    _getCurrentLocation();
  }

  Future<void> _getCurrentLocation() async {
    final loc = await locationService.getLocation();
    setState(() {
      currentLocation = LatLng(loc.latitude!, loc.longitude!);
      markers.add(Marker(
        markerId: const MarkerId("current"),
        position: currentLocation!,
        infoWindow: const InfoWindow(title: "Ù…ÙƒØ§Ù†ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ"),
        icon: BitmapDescriptor.defaultMarkerWithHue(BitmapDescriptor.hueBlue),
      ));
    });
  }

  double _calculateDistance(LatLng start, LatLng end) {
    const double R = 6371; // radius of Earth in km
    double dLat = _deg2rad(end.latitude - start.latitude);
    double dLon = _deg2rad(end.longitude - start.longitude);
    double a = 
        sin(dLat/2) * sin(dLat/2) +
        cos(_deg2rad(start.latitude)) * cos(_deg2rad(end.latitude)) *
        sin(dLon/2) * sin(dLon/2);
    double c = 2 * atan2(sqrt(a), sqrt(1-a));
    return R * c; // distance in km
  }

  double _deg2rad(double deg) => deg * pi / 180;

  void requestRide() {
    if (currentLocation != null && destinationLocation != null) {
      double km = _calculateDistance(currentLocation!, destinationLocation!);
      setState(() {
        fare = km * carTypes[selectedCar]!;
      });
    }
  }

  void confirmRide() {
    setState(() {
      searching = true;
    });

    Future.delayed(const Duration(seconds: 3), () {
      setState(() {
        searching = false;
        fare = null;
        destinationController.clear();
        markers.removeWhere((m) => m.markerId.value == "destination");
        destinationLocation = null;
      });

      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text("ğŸš• ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙƒØ³ÙŠ"),
            behavior: SnackBarBehavior.floating),
      );
    });
  }

  void updateSuggestions(String input) {
    setState(() {
      suggestions = popularPlaces
          .where((place) => place.contains(input))
          .toList();
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: currentLocation == null
          ? const Center(child: CircularProgressIndicator())
          : Stack(
              children: [
                GoogleMap(
                  initialCameraPosition: CameraPosition(
                    target: currentLocation!,
                    zoom: 15,
                  ),
                  myLocationEnabled: true,
                  zoomControlsEnabled: false,
                  onMapCreated: (controller) {
                    mapController = controller;
                  },
                  markers: markers,
                  onTap: (latLng) {
                    setState(() {
                      destinationLocation = latLng;
                      markers.removeWhere((m) => m.markerId.value == "destination");
                      markers.add(Marker(
                        markerId: const MarkerId("destination"),
                        position: latLng,
                        infoWindow: const InfoWindow(title: "Ø§Ù„ÙˆØ¬Ù‡Ø©"),
                      ));
                      destinationController.text = "";
                      suggestions.clear();
                    });
                  },
                ),
                Positioned(
                  bottom: 0,
                  left: 0,
                  right: 0,
                  child: Container(
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius:
                          const BorderRadius.vertical(top: Radius.circular(24)),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black26,
                          blurRadius: 15,
                          offset: const Offset(0, -3),
                        ),
                      ],
                    ),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        // Ø­Ù‚Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø© Ù…Ø¹ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
                        TextField(
                          controller: destinationController,
                          decoration: InputDecoration(
                            hintText: destinationLocation == null
                                ? "Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„ÙˆØ¬Ù‡Ø©"
                                : "ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©",
                            prefixIcon: const Icon(Icons.place, color: Colors.green),
                            filled: true,
                            fillColor: Colors.grey[100],
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12),
                              borderSide: BorderSide.none,
                            ),
                          ),
                          onChanged: (value) {
                            updateSuggestions(value);
                          },
                        ),
                        if (suggestions.isNotEmpty)
                          Container(
                            height: 80,
                            margin: const EdgeInsets.only(top: 5),
                            child: ListView.builder(
                              itemCount: suggestions.length,
                              itemBuilder: (context, index) {
                                return ListTile(
                                  title: Text(suggestions[index]),
                                  leading: const Icon(Icons.location_on, color: Colors.green),
                                  onTap: () {
                                    setState(() {
                                      destinationController.text = suggestions[index];
                                      suggestions.clear();
                                      // ÙŠÙ…ÙƒÙ† Ù‡Ù†Ø§ ØªØ­ÙˆÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø¥Ù„Ù‰ LatLng Ø¥Ø°Ø§ Ø£Ø±Ø¯Ù†Ø§
                                    });
                                  },
                                );
                              },
                            ),
                          ),
                        const SizedBox(height: 10),
                        // Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                          children: carTypes.keys.map((type) {
                            return ChoiceChip(
                              label: Text(type),
                              selected: selectedCar == type,
                              selectedColor: Colors.green,
                              onSelected: (selected) {
                                setState(() {
                                  selectedCar = type;
                                });
                              },
                            );
                          }).toList(),
                        ),
                        const SizedBox(height: 15),
                        // Ø²Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±
                        if (fare == null)
                          SizedBox(
                            width: double.infinity,
                            child: ElevatedButton(
                              onPressed: requestRide,
                              style: ElevatedButton.styleFrom(
                                padding: const EdgeInsets.symmetric(vertical: 16),
                                shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12)),
                                backgroundColor: Colors.transparent,
                                elevation: 0,
                              ).copyWith(
                                foregroundColor:
                                    MaterialStateProperty.all(Colors.white),
                              ),
                              child: Ink(
                                decoration: BoxDecoration(
                                  gradient: const LinearGradient(
                                      colors: [Colors.green, Colors.lightGreen]),
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                child: Container(
                                  alignment: Alignment.center,
                                  child: const Text(
                                    "Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±",
                                    style: TextStyle(fontSize: 18),
                                  ),
                                ),
                              ),
                            ),
                          ),
                        // Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨ ØªØ¸Ù‡Ø± Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø³Ø§ÙØ©
                        if (fare != null) ...[
                          const SizedBox(height: 12),
                          Card(
                            shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12)),
                            color: Colors.green[50],
                            child: ListTile(
                              leading: const Icon(Icons.map, color: Colors.green),
                              title: Text(
                                "Ø§Ù„Ù…Ø³Ø§ÙØ©: ${_calculateDistance(currentLocation!, destinationLocation!).toStringAsFixed(2)} ÙƒÙ…",
                                style: const TextStyle(fontWeight: FontWeight.bold),
                              ),
                            ),
                          ),
                          const SizedBox(height: 8),
                          Card(
                            shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12)),
                            color: Colors.green[100],
                            child: ListTile(
                              leading: const Icon(Icons.attach_money,
                                  color: Colors.green),
                              title: Text(
                                "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (${selectedCar}): ${fare!.toInt()} Ø¯ÙŠÙ†Ø§Ø±",
                                style: const TextStyle(
                                    fontSize: 18, fontWeight: FontWeight.bold),
                              ),
                            ),
                          ),
                          const SizedBox(height: 12),
                          SizedBox(
                            width: double.infinity,
                            child: ElevatedButton(
                              style: ElevatedButton.styleFrom(
                                padding: const EdgeInsets.symmetric(vertical: 16),
                                shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(12)),
                                backgroundColor: Colors.transparent,
                              ),
                              onPressed: confirmRide,
                              child: Ink(
                                decoration: BoxDecoration(
                                  gradient: const LinearGradient(
                                      colors: [Colors.green, Colors.lightGreen]),
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                child: Container(
                                  alignment: Alignment.center,
                                  child: const Text(
                                    "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨",
                                    style: TextStyle(
                                        fontSize: 18, color: Colors.white),
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ],
                      ],
                    ),
                  ),
                ),
                if (searching)
                  Container(
                    color: Colors.black45,
                    child: const Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          CircularProgressIndicator(color: Colors.white),
                          SizedBox(height: 12),
                          Text(
                            "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ØªÙƒØ³ÙŠ...",
                            style: TextStyle(color: Colors.white, fontSize: 18),
                          ),
                        ],
                      ),
                    ),
                  ),
              ],
            ),
    );
  }
}
